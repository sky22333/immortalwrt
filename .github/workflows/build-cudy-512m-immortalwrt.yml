name: 编译 ImmortalWrt v24.10.4 - cudy_tr3000-v1

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      DL_DIR: ${{ github.workspace }}/immortalwrt/downloads
    
    steps:
      # =============================
      # 清理磁盘空间
      # =============================
      - name: 清理磁盘空间
        run: |
          echo "清理前空间:"
          df -hT
          
          # 删除预装软件
          docker rmi `docker images -q`
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android
          sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo -E apt-get -y autoremove --purge || true
          sudo -E apt-get clean || true
          
          echo "清理后空间:"
          df -hT

      # =============================
      # 1. 安装依赖
      # =============================
      - name: 安装依赖
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext \
            gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool libyaml-dev lld llvm lrzsz genisoimage \
            ninja-build p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
            python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo \
            uglifyjs unzip wget xmlto xxd zlib1g-dev upx zstd
      
      # =============================
      # 2. 缓存 ccache
      # =============================
      - name: 缓存 ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-512mb
      
      # =============================
      # 3. 缓存 downloads
      # =============================
      - name: 缓存 downloads
        uses: actions/cache@v4
        with:
          path: immortalwrt/downloads
          key: ${{ runner.os }}-immortalwrt-downloads-v1
      
      # =============================
      # 4. 克隆 ImmortalWrt v24.10.4 源码
      # =============================
      - name: 克隆源码 v24.10.4
        run: |
          git clone -b v24.10.4 --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      # =============================
      # 5. 修改 DTSI 文件添加 reg 属性
      # =============================
      - name: 修改 DTSI 文件分区大小
        run: |
          cd immortalwrt
          
          DTSI_FILE="target/linux/mediatek/dts/mt7981b-cudy-tr3000-v1.dtsi"
          
          if [ ! -f "$DTSI_FILE" ]; then
            echo "错误: 未找到 DTSI 文件"
            exit 1
          fi
          
          echo "找到 DTSI 文件: $DTSI_FILE"
          cp "$DTSI_FILE" "${DTSI_FILE}.bak"
          
          echo "===== 原始 ubi 分区定义 ====="
          grep -B 1 -A 3 "ubi: partition@5c0000" "$DTSI_FILE"
          
          # 修改 ubi 分区，添加 reg 属性
          # 512MB 版本: reg = <0x5C0000 0x1FA40000>; (约 506MB)
          # 起始地址 0x5C0000 = 6MB (BL2+env+Factory+bdinfo+FIP)
          # 大小 0x1FA40000 = 512MB - 6MB ≈ 506MB
          
          sed -i '/ubi: partition@5c0000 {/a\				reg = <0x5C0000 0x1FA40000>;' "$DTSI_FILE"
          
          # 如果使用 112MB U-Boot，用这个:
          # sed -i '/ubi: partition@5c0000 {/a\				reg = <0x5C0000 0x7000000>;' "$DTSI_FILE"
          
          echo ""
          echo "===== 修改后的 ubi 分区定义 ====="
          grep -B 1 -A 4 "ubi: partition@5c0000" "$DTSI_FILE"
          
          # 验证修改
          if grep -q "reg = <0x5C0000 0x1FA40000>" "$DTSI_FILE"; then
            echo ""
            echo "✓ DTSI 已成功添加 512MB 分区定义 (0x1FA40000)"
          elif grep -q "reg = <0x5C0000 0x7000000>" "$DTSI_FILE"; then
            echo ""
            echo "✓ DTSI 已成功添加 112MB 分区定义 (0x7000000)"
          else
            echo ""
            echo "⚠ 警告: DTSI 分区修改可能未生效"
            cat "$DTSI_FILE"
            exit 1
          fi
      
      # =============================
      # 6. 修改 Makefile
      # =============================
      - name: 修改 Makefile 分区参数
        run: |
          cd immortalwrt
          
          MAKEFILE="target/linux/mediatek/image/filogic.mk"
          
          if [ ! -f "$MAKEFILE" ]; then
            echo "错误: 未找到 Makefile"
            exit 1
          fi
          
          echo "找到 Makefile: $MAKEFILE"
          cp "$MAKEFILE" "${MAKEFILE}.bak"
          
          echo "===== 原始 cudy_tr3000-v1 配置 ====="
          sed -n '/^define Device\/cudy_tr3000-v1$/,/^endef$/p' "$MAKEFILE"
          
          # 修改 IMAGE_SIZE 为 512MB (约 500MB 可用)
          # 65536k (64MB) -> 512000k (约 500MB)
          sed -i '/^define Device\/cudy_tr3000-v1$/,/^endef$/{
            s/IMAGE_SIZE := 65536k/IMAGE_SIZE := 512000k/
          }' "$MAKEFILE"
          
          # 如果使用 112MB U-Boot，用这个值:
          # sed -i '/^define Device\/cudy_tr3000-v1$/,/^endef$/{ s/IMAGE_SIZE := 65536k/IMAGE_SIZE := 112000k/ }' "$MAKEFILE"
          
          echo ""
          echo "===== 修改后的 cudy_tr3000-v1 配置 ====="
          sed -n '/^define Device\/cudy_tr3000-v1$/,/^endef$/p' "$MAKEFILE"
          
          # 验证修改
          if grep -q "IMAGE_SIZE := 512000k" "$MAKEFILE"; then
            echo ""
            echo "✓ Makefile IMAGE_SIZE 已成功修改为 512MB"
          else
            echo ""
            echo "⚠ 警告: IMAGE_SIZE 修改可能未生效"
            exit 1
          fi
      
      # =============================
      # 7. 配置编译目标
      # =============================
      - name: 配置编译目标
        run: |
          cd immortalwrt
          
          # 生成默认配置
          cat > .config <<EOF
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_cudy_tr3000-v1=y
          CONFIG_TARGET_ROOTFS_PARTSIZE=500
          
          # 额外插件
          CONFIG_PACKAGE_curl=y
          CONFIG_PACKAGE_luci-theme-argon=y
          CONFIG_PACKAGE_luci-i18n-homeproxy-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-ttyd-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-diskman-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-filemanager-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-package-manager-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
          EOF
          
          # 应用默认配置
          make defconfig
          
          echo "===== 当前编译配置 ====="
          grep "CONFIG_TARGET\|PARTSIZE" .config | grep -v "^#"
      
      # =============================
      # 8. 显示配置信息
      # =============================
      - name: 显示配置信息
        run: |
          cd immortalwrt
          
          echo "===== DTSI 文件路径 ====="
          find target/linux/mediatek/dts -name "*cudy*tr3000*.dtsi"
          
          echo ""
          echo "===== DTSI 分区布局 ====="
          cat target/linux/mediatek/dts/mt7981b-cudy-tr3000-v1.dtsi
      
      # =============================
      # 9. 下载依赖
      # =============================
      - name: 下载依赖包
        run: |
          cd immortalwrt
          make download -j8 || make download -j1 V=s
      
      # =============================
      # 10. 编译固件
      # =============================
      - name: 编译固件 (多线程)
        run: |
          cd immortalwrt
          
          echo "开始编译 512MB 大分区固件..."
          echo "CPU 核心数: $(nproc)"
          echo "编译开始时间: $(date)"
          
          # 第一次尝试: 多线程静默编译 (最快)
          # 如果失败,则用单线程详细输出重试 (便于调试)
          make -j$(($(nproc) + 1)) V=w || make -j1 V=s
          
          echo "编译完成时间: $(date)"
      
      # =============================
      # 11. 检查编译产物
      # =============================
      - name: 检查编译产物
        run: |
          cd immortalwrt
          
          echo "===== 编译产物列表 ====="
          ls -lh bin/targets/mediatek/filogic/ || echo "未找到编译产物"
          
          # 显示固件大小
          echo ""
          echo "===== 固件文件详情 ====="
          find bin/targets/mediatek/filogic/ -name "*.bin" -exec ls -lh {} \;
      
      # =============================
      # 12. 上传固件
      # =============================
      - name: 上传固件到 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cudy_tr3000-v1-512mb-firmware
          path: |
            immortalwrt/bin/targets/mediatek/filogic/*sysupgrade*.bin
            immortalwrt/bin/targets/mediatek/filogic/*factory*.bin
            immortalwrt/bin/targets/mediatek/filogic/sha256sums
      
      # =============================
      # 13. 创建 Release
      # =============================
      - name: 发布 Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: immortalwrt/bin/targets/mediatek/filogic/*sysupgrade*.bin
          tag: 'v512mb-${{ github.run_id }}'
          name: 'Cudy TR3000-v1 512MB 大分区固件'
          body: |
            ## ⚠️ 重要警告
            
            **此固件仅适用于已硬件改装为 512MB 闪存的设备!**
            
            **刷机前必须完成以下步骤:**
            1. ✅ 已将闪存硬件改装为 512MB
            2. ✅ 已刷入支持大分区的第三方 U-Boot
            3. ✅ 已备份原厂 FIP 分区
            
            **如果没有完成上述步骤,刷入此固件会导致设备无法启动!**
            
            ---
            
            ## 固件信息
            - 设备: Cudy TR3000-v1
            - 闪存: 512MB (硬件改装版)
            - 系统: ImmortalWrt v24.10.4
            - 分区大小: 约 506MB 可用空间 (0x1FA40000)
            - 编译时间: ${{ github.event.head_commit.timestamp }}
            - 构建编号: ${{ github.run_id }}
            
            ## 修改说明
            - DTSI: 添加 `reg = <0x5C0000 0x1FA40000>` 到 ubi 分区
            - 起始地址: 0x5C0000 (约 6MB)
            - 分区大小: 0x1FA40000 (约 506MB)
            
            ## 刷机步骤
            1. 确认已安装支持 512MB 的 U-Boot
            2. 通过 LuCI 界面上传固件
            3. **取消勾选"保留配置"**
            4. 刷入并重启
            
            ## 参考文章
            [参考文章链接](https://www.regecc.net/cudy-tr3000-openwrt-build-firmware-expand-storage-zh/)
            
            ## 风险提示
            - 刷机有风险,操作需谨慎
            - 建议提前备份重要数据
            - 如出现问题,可恢复原厂 FIP 分区
          draft: false
          prerelease: false
